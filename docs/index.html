<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa de coletas do Herbário do Núpelia UEM (HNUP-UEM)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #EAF3E1;
    }
    #header {
      background-color: #BBD3A2;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      font-size: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: relative;
    }
    #logo-left {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
    #logo-right {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
    }
    #container {
      display: grid;
      grid-template-columns: 300px 1fr;
      grid-template-rows: auto 1fr auto auto;
      gap: 10px;
      padding: 10px;
    }
    #sidebar {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .box {
      background-color: #F2F7F1;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .box-title {
      background-color: #6B8E6F;
      color: white;
      padding: 5px 10px;
      border-radius: 10px 10px 0 0;
      font-weight: bold;
    }
    #map {
      background-color: #6B8E6F;
      border-radius: 10px;
      height: 500px;
    }
    #info, #links {
      grid-column: 1 / -1;
    }
    ul {
      padding-left: 20px;
    }
    .leaflet-control-attribution {
      display: none;
    }
    .family-header {
      color: black;
      font-weight: bold;
    }
    .genus-header {
      color: red;
      font-style: italic;
    }
    .species-item {
      color: blue;
      font-style: italic;
    }
    .hidden {
      display: none;
    }
    .search-container {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }
    .search-container input[type="text"] {
      flex: 1;
      padding: 5px;
    }
    .search-container button {
      padding: 5px 10px;
      background-color: #6B8E6F;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="header">
    <img id="logo-right" src="logo_lab.png" alt="Logo NUPELIA">
    Mapa de coletas do Herbário do Núpelia UEM (HNUP-UEM)<br>
    <span style="font-size:14px; font-weight:normal;">Laboratório de Vegetação Ripária - NUPELIA - UEM</span>
    <img id="logo-left" src="logo_uem.jpeg" alt="Logo UEM">
  </div>

  <div id="container">
    <div id="sidebar">
      <div class="box" style="height: 300px;">
        <div class="box-title">Barra de pesquisa de espécie</div>
        <div class="search-container">
          <input type="text" id="searchBox" placeholder="Digite uma espécie...">
          <button onclick="clearSearch()">Limpar</button>
        </div>
        <div id="speciesList" style="overflow-y:auto; height:200px;"></div>
      </div>
      <div class="box">
        <div class="box-title">Filtros</div>
        <ul>
          <li>Filtro 1</li>
          <li>Filtro 2</li>
          <li>Filtro 3</li>
        </ul>
      </div>
    </div>

    <div class="box" id="map"></div>

    <div class="box" id="info">
      <div class="box-title">Informações relevantes</div>
      <ul>
        <li>Info 1</li>
        <li>Info 2</li>
        <li>Info 3</li>
        <li>Info 4</li>
      </ul>
    </div>

    <div class="box" id="links">
      <div class="box-title">Links Importantes</div>
      <ul>
        <li>Site 1 - Link 1</li>
        <li>Site 2 - Link 2</li>
        <li>Site 3 - Link 3</li>
      </ul>
    </div>
  </div>

  <div style="position:fixed; bottom:10px; right:10px; font-size:12px; background:#F2F7F1; padding:5px; border-radius:8px;">
    Criado por Vitor Eduardo Girotto Barelli<br>
    Leaflet | Leaflet | Ⓒ OpenStreetMap contributors
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script>
    const map = L.map('map').setView([-22.5, -53.5], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Leaflet | © OpenStreetMap contributors'
    }).addTo(map);

    const markers = L.markerClusterGroup();
    const familySpecies = {};
    const genusSpecies = {};
    const speciesMarkers = {};
    const speciesCount = {};
    const genusCount = {};
    const familyCount = {};

    fetch('dados1.json')
      .then(res => res.json())
      .then(data => {
        data.forEach(d => {
          const sp = d.nome || '';
          if (!sp) return;
          const gen = d.genero || 'Desconhecido';
          const fam = d.familia || 'Desconhecida';

          speciesCount[sp] = (speciesCount[sp]||0) + 1;
          if (!familySpecies[fam]) familySpecies[fam] = new Set();
          familySpecies[fam].add(gen);
          if (!genusSpecies[gen])  genusSpecies[gen] = new Set();
          genusSpecies[gen].add(sp);

          const popup = `<b>Espécie:</b> ${sp}<br><b>Gênero:</b> ${gen}<br><b>Família:</b> ${fam}<br><br>` +
                        `<b>Ano de coleta:</b> ${d.ano_coleta || 'Não informado'}<br>` +
                        `<b>Município:</b> ${d.municipio || 'Não informado'}<br>` +
                        `<b>Coletas:</b> ${d.numero_coletas || 'Não informado'}<br>` +
                        `<b>Habitat:</b> ${d.habitat || 'Não informado'}<br>` +
                        `<b>Descrição:</b> ${d.descricao || '—'}<br>` +
                        `<b>Notas:</b> ${d.notas || '—'}`;

          const m = L.marker([d.latitude, d.longitude]).bindPopup(popup);
          markers.addLayer(m);
          if (!speciesMarkers[sp]) speciesMarkers[sp] = [];
          speciesMarkers[sp].push(m);
        });

        Object.keys(genusSpecies).forEach(gen => {
          genusCount[gen] = 0;
          genusSpecies[gen].forEach(sp => {
            genusCount[gen] += speciesCount[sp] || 0;
          });
        });

        Object.keys(familySpecies).forEach(fam => {
          familyCount[fam] = 0;
          familySpecies[fam].forEach(gen => {
            familyCount[fam] += genusCount[gen] || 0;
          });
        });

        map.addLayer(markers);
        populateList();
      });

    function focusSp(sp) {
      markers.clearLayers();
      const arr = [];
      (speciesMarkers[sp]||[]).forEach(m => { markers.addLayer(m); arr.push(m); });
      if (arr.length) map.fitBounds(L.featureGroup(arr).getBounds().pad(0.25));
    }

    function focusGen(gen) {
      markers.clearLayers();
      const arr = [];
      Array.from(genusSpecies[gen]||[]).forEach(sp => {
        (speciesMarkers[sp]||[]).forEach(m => { markers.addLayer(m); arr.push(m); });
      });
      if (arr.length) map.fitBounds(L.featureGroup(arr).getBounds().pad(0.25));
    }

    function focusFam(fam) {
      markers.clearLayers();
      const arr = [];
      Array.from(familySpecies[fam]||[]).forEach(gen => {
        Array.from(genusSpecies[gen]||[]).forEach(sp => {
          (speciesMarkers[sp]||[]).forEach(m => { markers.addLayer(m); arr.push(m); });
        });
      });
      if (arr.length) map.fitBounds(L.featureGroup(arr).getBounds().pad(0.25));
    }

    function populateList() {
      const ul = document.getElementById('speciesList');
      ul.innerHTML = '';
      Object.keys(familySpecies).sort().forEach(fam => {
        const fli = document.createElement('div');
        fli.textContent = `${fam} (${familyCount[fam]})`;
        fli.className = 'family-header';
        fli.style.fontWeight = 'bold';
        const famBlock = document.createElement('div');

        fli.onclick = () => {
          famBlock.classList.toggle('hidden');
          focusFam(fam);
        };
        ul.appendChild(fli);
        ul.appendChild(famBlock);

        Array.from(familySpecies[fam]).sort().forEach(gen => {
          const gli = document.createElement('div');
          gli.textContent = `${gen} (${genusCount[gen]})`;
          gli.className = 'genus-header';
          const genBlock = document.createElement('div');
          genBlock.style.marginLeft = '15px';

          gli.onclick = () => {
            genBlock.classList.toggle('hidden');
            focusGen(gen);
          };
          famBlock.appendChild(gli);
          famBlock.appendChild(genBlock);

          Array.from(genusSpecies[gen]).sort().forEach(sp => {
            const sli = document.createElement('div');
            sli.textContent = `${sp} (${speciesCount[sp]})`;
            sli.className = 'species-item';
            sli.style.marginLeft = '15px';
            sli.onclick = () => focusSp(sp);
            genBlock.appendChild(sli);
          });
        });
      });
    }

    function clearSearch() {
      document.getElementById('searchBox').value = '';
      markers.clearLayers();
      Object.values(speciesMarkers).flat().forEach(m => markers.addLayer(m));
      map.setView([-22.5, -53.5], 2);
    }

    document.getElementById('searchBox').addEventListener('input', e => {
      const v = e.target.value.trim();
      if (v && speciesMarkers[v]) focusSp(v);
    });
  </script>
</body>
</html>
