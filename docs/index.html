<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa Interativo - Piperaceae</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    body { margin:0; padding:0; }
    #topbar { position:absolute; top:0; left:0; width:100%; height:80px; background:white; z-index:1002;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      font-size:24px; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.1); padding-top:5px; }
    #map { position:absolute; top:80px; right:0; bottom:0; left:300px; }
    #sidebar { position:absolute; top:90px; left:10px; bottom:10px; width:280px;
      background:white; padding:10px; overflow-y:auto; z-index:1001; box-shadow:0 0 5px rgba(0,0,0,0.5); }
    input, button { width:100%; margin-bottom:5px; padding:5px; }
    .species-list { list-style:none; padding:0; margin:0; }
    .family-header { font-weight:bold; margin-top:10px; }
    .genus-header { margin-left:10px; }
    .species-item { margin-left:20px; color:#007bff; cursor:pointer; }
    .leaflet-control-author { background: rgba(255,255,255,0.8); padding:2px 6px; font-size:12px; }
  </style>
</head>
<body>
  <div id="topbar">
    Mapa de coletas do HNUP<br>
    <span style="font-size:16px; font-weight:normal;">Laboratório de Vegetação Ripária - NUPELIA - UEM</span>
    <img src="logo_lab.png" alt="Logo NUPELIA" style="position:absolute; top:0; right:0; height:80px;">
  </div>
  <div id="sidebar">
    <h2>Filtros Avançados</h2>
    <button onclick="clearAll()">Limpar seleção</button>
    <h3>Famílias, Gêneros e Espécies</h3>
    <ul id="filterList" class="species-list"></ul>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script>
    const map = L.map('map').setView([-22.5, -53.5], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:18, attribution:'Leaflet | © OpenStreetMap contributors'
    }).addTo(map);

    const markers = L.markerClusterGroup();
    const speciesMarkers = {}, genusMembers = {}, familyMembers = {};

    let dataAll = [];

    fetch('dados_piperaceae.json').then(r=>r.json()).then(data=>{
      dataAll = data;
      data.forEach(d=>{
        const sp=d.especie, gen=d.genero||'Desconhecido', fam=d.familia||'Desconhecida';
        const m = L.marker([d.latitude,d.longitude]).bindPopup(
          `<b>Espécie:</b> ${sp}<br><b>Gênero:</b> ${gen}<br><b>Família:</b> ${fam}`+
          `<br><b>Ano:</b> ${d.ano||''}`
        );
        markers.addLayer(m);
        speciesMarkers[sp] = speciesMarkers[sp]||[]; speciesMarkers[sp].push(m);
        genusMembers[gen]   = genusMembers[gen]||new Set(); genusMembers[gen].add(sp);
        familyMembers[fam]  = familyMembers[fam]||new Set(); familyMembers[fam].add(gen);
      });
      map.addLayer(markers);
      buildFilterList();
    });

    function buildFilterList(){
      const ul = document.getElementById('filterList');
      ul.innerHTML='';
      Object.keys(familyMembers).sort().forEach(fam=>{
        const liFam = document.createElement('li');
        liFam.className='family-header';
        liFam.innerHTML = `<label><input type="checkbox" class="fam" value="${fam}"> ${fam}</label>`;
        ul.appendChild(liFam);
        Array.from(familyMembers[fam]).sort().forEach(gen=>{
          const liGen = document.createElement('li');
          liGen.className='genus-header';
          liGen.innerHTML = `<label><input type="checkbox" class="gen" data-fam="${fam}" value="${gen}"> ${gen}</label>`;
          ul.appendChild(liGen);
          Array.from(genusMembers[gen]).sort().forEach(sp=>{
            const liSp = document.createElement('li');
            liSp.className='species-item';
            liSp.innerHTML = `<label><input type="checkbox" class="sp" data-gen="${gen}" value="${sp}"> ${sp}</label>`;
            ul.appendChild(liSp);
          });
        });
      });
      document.querySelectorAll('#filterList input').forEach(cb=>cb.onchange=updateFilters);
    }

    function updateFilters(){
      markers.clearLayers();
      const selFams = [...document.querySelectorAll('.fam:checked')].map(i=>i.value);
      const selGens = [...document.querySelectorAll('.gen:checked')].map(i=>i.value);
      const selSps  = [...document.querySelectorAll('.sp:checked')].map(i=>i.value);
      let toShow = new Set();

      if(selSps.length){
        selSps.forEach(sp=>speciesMarkers[sp].forEach(m=>toShow.add(m)));
      }
      if(selGens.length){
        selGens.forEach(gen=>genusMembers[gen].forEach(sp=>speciesMarkers[sp].forEach(m=>toShow.add(m))));
      }
      if(selFams.length){
        selFams.forEach(fam=>familyMembers[fam].forEach(gen=>genusMembers[gen].forEach(sp=>speciesMarkers[sp].forEach(m=>toShow.add(m)))));
      }
      if(!selSps.length && !selGens.length && !selFams.length){
        dataAll.forEach(d=>speciesMarkers[d.especie].forEach(m=>toShow.add(m)));
      }
      toShow.forEach(m=>markers.addLayer(m));
      if(toShow.size) map.fitBounds(L.featureGroup([...toShow]).getBounds().pad(0.25));
    }

    function clearAll(){
      document.querySelectorAll('#filterList input').forEach(i=>i.checked=false);
      updateFilters();
    }
  </script>
</body>
</html>
