<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa de coletas do Herbário do Núpelia UEM (HNUP-UEM)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #EAF3E1;
    }
    #header {
      background-color: #6B8E6F;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      font-size: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: relative;
      height: 80px;
    }
    #logo-left, #logo-right {
      position: absolute;
      top: 0;
      height: 100%;
    }
    #logo-left { left: 0; }
    #logo-right { right: 0; }

    #container {
      display: grid;
      grid-template-columns: 250px 300px 1fr;
      grid-template-rows: auto auto auto;
      gap: 10px;
      padding: 10px;
    }
    #sidebar {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .box {
      background-color: #F2F7F1;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .box-title {
      background-color: #6B8E6F;
      color: white;
      padding: 5px 10px;
      border-radius: 10px 10px 0 0;
      font-weight: bold;
    }
    #map {
      background-color: #6B8E6F;
      border-radius: 10px;
      height: 500px;
    }

    #species {
      height: 500px;
      display: flex;
      flex-direction: column;
    }
    
    #speciesHeader {
      flex-shrink: 0;
    }
    
    #speciesList.scroll-species-list {
      flex: 1;
      overflow-y: auto;
      margin-top: 10px;
    }
        /* Ajusta altura máxima das caixas laterais*/
    #filters {
      height: 500px;
      overflow-y: auto;
    }
    
    /* Estiliza a barra de rolagem (opcional, mas deixa mais bonito) */
    #filters::-webkit-scrollbar,
    #species::-webkit-scrollbar {
      width: 8px;
    }
    
    #filters::-webkit-scrollbar-thumb,
    #species::-webkit-scrollbar-thumb {
      background-color: #A2B8A5;
      border-radius: 5px;
    }
    #info, #links {
      grid-column: 1 / -1;
    }
    ul {
      padding-left: 20px;
    }
    .leaflet-control-attribution {
      display: none;
    }
    .family-header {
      color: black;
      font-weight: bold;
    }
    .genus-header {
      color: red;
      font-style: italic;
    }
    .species-item {
      color: blue;
      font-style: italic;
    }
    .search-box {
      width: 100%;
      margin-bottom: 5px;
      box-sizing: border-box;
      padding: 5px;
    }
    .taxon-buttons button {
      margin-bottom: 5px;
      width: 100%;
    }
    .filter-header {
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      color: #333;
    }
    .filter-options {
      margin-left: 15px;
      margin-top: 5px;
    }
    .filter-checkbox {
      display: block;
      margin-bottom: 5px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="header">
    <img id="logo-left" src="logo_uem.jpeg" alt="Logo UEM">
    Mapa de coletas do Herbário do Núpelia UEM (HNUP-UEM)<br>
    <span style="font-size:20px; font-weight:normal;">Laboratório de Vegetação Ripária - NUPELIA - UEM</span>
    <img id="logo-right" src="logo_lab.png" alt="Logo NUPELIA">
  </div>

  <div id="container">
      <!-- Coluna 1 - Filtros -->
    <div id="filters" class="box">
      <div class="box-title">Filtros</div>
      <div>
        <div class="filter-header" onclick="toggleFilter('yearFilter')">Ano de coleta</div>
        <div id="yearFilter" class="filter-options hidden"></div>
        <div class="filter-header" onclick="toggleFilter('municipioFilter')">Localização</div>
        <div id="municipioFilter" class="filter-options hidden"></div>
        <button onclick="clearFilters()" style="margin-top: 10px; width: 100%;">Limpar filtros</button>
      </div>
    </div>
  
    <!-- Coluna 2 - Lista de espécies -->
    <div id="species" class="box">
      <div class="box-title">Barra de pesquisa de espécie</div>
        <!-- Contêiner fixo (sem rolagem) -->
      <div id="speciesHeader">
        <input type="text" id="searchBox" placeholder="Digite uma espécie..." class="search-box" list="speciesSuggestions">
        <datalist id="speciesSuggestions"></datalist>
        <div class="taxon-buttons">
          <button onclick="applyTaxonSelection()">Aplicar seleção taxonômica</button>
          <button onclick="clearTaxonSelection()">Limpar seleção</button>
        </div>
      </div>
    
      <!-- Contêiner com rolagem -->
      <div id="speciesList" class="scroll-species-list"></div>
    </div>
 
    <!-- Coluna 3 - Mapa -->
    <div class="box" id="map" style="height: 500px;"></div>
  
    <!-- Informações relevantes -->
    <div class="box" id="info" style="grid-column: 1 / -1;">
      <div class="box-title">Informações relevantes</div>
      <ul>
        <li>A organização da lista de espécies está na ordem: Família (em preto), Gênero (em vermelho) e Espécie (em azul).</li>
        <li>Para utilizar a caixa de busca "Digite uma espécie..." deve ser escrito o epíteto específico, iu seja, o segundo nome da espécie, e deve estar escrito corretamente como informado na lista.<li>
        <li>Ao marcar uma caixinha de qualquer um dos níveis, clique em "Aplicar seleção taxonômica" para o mapa atualizar, quando terminar sua vizualização clique em "Limpar seleção" para reiniciar o mapa.</li>
        <li>Ao clicar em cima de um localizador de coleta, ele mostra as informações detalhadas da amostra.</li>
        <li>Coletas com coordenadas ausentes são exibidas em (0,0) — estamos corrigindo isso.</li>
        <li>Este site é um projeto do Laboratório de Vegetação Ripária - Núpelia - UEM.</li>
        <li>Link: <a href="https://cpr.uem.br/index.php/catalogos/2415-laboratorio-de-vegetacao-riparia" target="_blank">Site do laboratório</a></li>
        <li>Contato: <a href="mailto:vitorbarelli@gmail.com">vitorbarelli@gmail.com</a></li>
      </ul>
    </div>
  
    <!-- Links importantes -->
    <div class="box" id="links" style="grid-column: 1 / -1;">
      <div class="box-title">Links Importantes</div>
      <ul>
        <li>Site 1 - Link 1</li>
        <li>Site 2 - Link 2</li>
        <li>Site 3 - Link 3</li>
      </ul>
    </div>
  </div>

  <div style="position:fixed; bottom:10px; right:10px; font-size:12px; background:#F2F7F1; padding:5px; border-radius:8px;">
    Criado por Vitor Eduardo Girotto Barelli<br>
    Leaflet | Ⓒ OpenStreetMap contributors
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="mapa_script.js"></script>
  <script>
    // --- Funções auxiliares ---
    function toggleFilter(id) {
      const el = document.getElementById(id);
      el.classList.toggle('hidden');
    }
    
    const map = L.map('map').setView([-22.5, -53.5], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Leaflet | © OpenStreetMap contributors'
    }).addTo(map);
    
    const markers = L.markerClusterGroup();
    const familySpecies = {};
    const genusSpecies = {};
    const speciesMarkers = {};
    const speciesCount = {};
    const genusCount = {};
    const familyCount = {};
    
    fetch('dados1.json')
      .then(res => res.json())
      .then(data => {
        const anos = new Set();
        const municipios = new Set();
    
        data.forEach(d => {
          const sp = d.nome || '';
          if (!sp) return;
          const gen = d.genero || 'Desconhecido';
          const fam = d.familia || 'Desconhecida';
    
          speciesCount[sp] = (speciesCount[sp] || 0) + 1;
          if (!familySpecies[fam]) familySpecies[fam] = new Set();
          familySpecies[fam].add(gen);
          if (!genusSpecies[gen]) genusSpecies[gen] = new Set();
          genusSpecies[gen].add(sp);
    
          if (d.ano_coleta !== undefined) anos.add(d.ano_coleta);
          if (d.municipio) municipios.add(d.municipio);
    
          const popup = `<b>Espécie:</b> ${sp}<br><b>Gênero:</b> ${gen}<br><b>Família:</b> ${fam}<br><br>` +
                        `<b>Ano de coleta:</b> ${d.ano_coleta || 'Não informado'}<br>` +
                        `<b>Município:</b> ${d.municipio || 'Não informado'}<br>` +
                        `<b>Coletas:</b> ${d.numero_coletas || 'Não informado'}<br>` +
                        `<b>Habitat:</b> ${d.habitat || 'Não informado'}<br>` +
                        `<b>Descrição:</b> ${d.descricao || '—'}<br>` +
                        `<b>Notas:</b> ${d.notas || '—'}`;
    
          const m = L.marker([d.latitude, d.longitude]).bindPopup(popup);
          markers.addLayer(m);
          if (!speciesMarkers[sp]) speciesMarkers[sp] = [];
          speciesMarkers[sp].push(m);
        });
    
        map.addLayer(markers);
        Object.keys(genusSpecies).forEach(gen => {
          genusCount[gen] = 0;
          genusSpecies[gen].forEach(sp => {
            genusCount[gen] += speciesCount[sp] || 0;
          });
        });
        Object.keys(familySpecies).forEach(fam => {
          familyCount[fam] = 0;
          familySpecies[fam].forEach(gen => {
            familyCount[fam] += genusCount[gen] || 0;
          });
        });
        populateFilters(anos, municipios);
        populateList();
      });
    
    function populateFilters(anos, municipios) {
      const yearFilter = document.getElementById('yearFilter');
      [...anos].sort((a, b) => a - b).forEach(ano => {
        if (ano === 0 || ano === '0') return;
        const label = document.createElement('label');
        label.className = 'filter-checkbox';
        label.innerHTML = `<input type="checkbox" name="year" value="${ano}" onchange="applyFilters()"> ${ano}`;
        yearFilter.appendChild(label);
      });
    
      const municipioFilter = document.getElementById('municipioFilter');
      [...municipios].sort().forEach(m => {
        const label = document.createElement('label');
        label.className = 'filter-checkbox';
        label.innerHTML = `<input type="checkbox" name="municipio" value="${m}" onchange="applyFilters()"> ${m}`;
        municipioFilter.appendChild(label);
      });
    }
    
    function applyFilters() {
      const years = [...document.querySelectorAll('input[name="year"]:checked')].map(el => el.value);
      const municipios = [...document.querySelectorAll('input[name="municipio"]:checked')].map(el => el.value);
    
      markers.clearLayers();
      const arr = [];
    
      Object.keys(speciesMarkers).forEach(sp => {
        speciesMarkers[sp].forEach(m => {
          const popup = m.getPopup().getContent();
          const matchYear = years.length === 0 || years.some(y => popup.includes(y));
          const matchMunicipio = municipios.length === 0 || municipios.some(m => popup.includes(m));
          if (matchYear && matchMunicipio) {
            markers.addLayer(m);
            arr.push(m);
          }
        });
      });
    
      if (arr.length) map.fitBounds(L.featureGroup(arr).getBounds().pad(0.25));
    }
    
    function populateList() {
        const ul = document.getElementById('speciesList');
        ul.innerHTML = '';
        window.selectedFamilies = new Set();
        window.selectedGenera = new Set();
        window.selectedSpecies = new Set();
        const speciesContainer = document.getElementById('species');
        const speciesList = document.getElementById('speciesList');
        speciesList.innerHTML = '';
      
        // Evita duplicação: remove os elementos fixos se já existirem
        const oldSearch = document.getElementById('searchBox');
        if (oldSearch) oldSearch.remove();
        const oldButtons = document.querySelector('.taxon-buttons');
        if (oldButtons) oldButtons.remove();
      
        // Campo de busca (fixo)
        const searchBox = document.createElement('input');
        searchBox.type = 'text';
        searchBox.id = 'searchBox';
        searchBox.placeholder = 'Digite uma espécie...';
        searchBox.className = 'search-box';
        searchBox.addEventListener('input', searchSpecies);
        speciesContainer.insertBefore(searchBox, speciesList);
      
        // Botões (fixos)
        const buttonBlock = document.createElement('div');
        buttonBlock.className = 'taxon-buttons';
        buttonBlock.innerHTML = `
          <button onclick="applyTaxonSelection()">Aplicar seleção taxonômica</button>
          <button onclick="clearTaxonSelection()">Limpar seleção</button>
        `;
        speciesContainer.insertBefore(buttonBlock, speciesList);
      
        // Preenchimento da lista taxonômica
        Object.keys(familySpecies).sort().forEach(fam => {
          const fli = document.createElement('div');
          fli.innerHTML = `<label class="family-header"><input type="checkbox" class="taxon-checkbox" data-type="family" value="${fam}"> ${fam} (${familyCount[fam] || 0})</label>`;
          speciesList.appendChild(fli);
          const famBlock = document.createElement('div');
          famBlock.style.marginLeft = '15px';
          speciesList.appendChild(famBlock);
      
          Array.from(familySpecies[fam]).sort().forEach(gen => {
            const gli = document.createElement('div');
            gli.innerHTML = `<label class="genus-header"><input type="checkbox" class="taxon-checkbox" data-type="genus" value="${gen}"> ${gen} (${genusCount[gen] || 0})</label>`;
            famBlock.appendChild(gli);
            const genBlock = document.createElement('div');
            genBlock.style.marginLeft = '15px';
            famBlock.appendChild(genBlock);
      
            Array.from(genusSpecies[gen]).sort().forEach(sp => {
              const sli = document.createElement('div');
              sli.innerHTML = `<label class="species-item"><input type="checkbox" class="taxon-checkbox" data-type="species" value="${sp}"> ${sp} (${speciesCount[sp] || 0})</label>`;
              genBlock.appendChild(sli);
            });
          });
        });
        // ✅ Preenche datalist com sugestões para autocomplete (adicione aqui)
        const datalist = document.getElementById('speciesSuggestions');
        if (datalist) {
        datalist.innerHTML = '';
        Object.keys(speciesMarkers).sort().forEach(sp => {
          const option = document.createElement('option');
          option.value = sp;
          datalist.appendChild(option);
        });
      }
    }
    function applyTaxonSelection() {
      selectedFamilies.clear();
      selectedGenera.clear();
      selectedSpecies.clear();
    
      document.querySelectorAll('.taxon-checkbox:checked').forEach(el => {
        const type = el.getAttribute('data-type');
        const val = el.value;
        if (type === 'family') selectedFamilies.add(val);
        else if (type === 'genus') selectedGenera.add(val);
        else if (type === 'species') selectedSpecies.add(val);
      });
    
      markers.clearLayers();
      const arr = [];
    
      Object.keys(speciesMarkers).forEach(sp => {
        const matches =
          selectedSpecies.has(sp) ||
          Array.from(selectedGenera).some(gen => genusSpecies[gen]?.has(sp)) ||
          Array.from(selectedFamilies).some(fam => {
            return Array.from(familySpecies[fam] || []).some(gen => genusSpecies[gen]?.has(sp));
          });
    
        if (matches) {
          speciesMarkers[sp].forEach(m => {
            markers.addLayer(m);
            arr.push(m);
          });
        }
      });
    
      if (arr.length) map.fitBounds(L.featureGroup(arr).getBounds().pad(0.25));
    }
    
    function clearTaxonSelection() {
      document.querySelectorAll('.taxon-checkbox').forEach(el => el.checked = false);
      selectedFamilies.clear();
      selectedGenera.clear();
      selectedSpecies.clear();
      clearSearch();
    }
    
    function searchSpecies() {
      const query = document.getElementById('searchBox').value.trim().toLowerCase();
      const match = Object.keys(speciesMarkers).find(sp => sp.toLowerCase() === query);
      if (match) focusSp(match);
    }
    
    function clearSearch() {
      document.getElementById('searchBox').value = '';
      markers.clearLayers();
      Object.values(speciesMarkers).flat().forEach(m => markers.addLayer(m));
      map.setView([-22.5, -53.5], 2);
    }
    
    function clearFilters() {
      document.querySelectorAll('input[name="year"]:checked, input[name="municipio"]:checked')
        .forEach(input => input.checked = false);
      applyFilters();
    }
    function focusSp(sp) {
      const markersArray = speciesMarkers[sp];
      if (!markersArray || markersArray.length === 0) return;
    
      // Dá zoom no primeiro marcador da espécie
      const group = L.featureGroup(markersArray);
      map.fitBounds(group.getBounds().pad(0.25));
    
      // Abre popup do primeiro marcador
      markersArray[0].openPopup();
    }
  </script>
</body>
</html>
