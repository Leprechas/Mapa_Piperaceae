<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa de coletas do Herbário do Núpelia UEM (HNUP-UEM)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #EAF3E1;
    }
    #header {
      background-color: #BBD3A2;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      font-size: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: relative;
      height: 80px;
    }
    #logo-left {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
    #logo-right {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
    }
    #container {
      display: grid;
      grid-template-columns: 300px 1fr;
      grid-template-rows: auto 1fr auto auto;
      gap: 10px;
      padding: 10px;
    }
    #sidebar {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .box {
      background-color: #F2F7F1;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .box-title {
      background-color: #6B8E6F;
      color: white;
      padding: 5px 10px;
      border-radius: 10px 10px 0 0;
      font-weight: bold;
    }
    #map {
      background-color: #6B8E6F;
      border-radius: 10px;
      height: 500px;
    }
    #info, #links {
      grid-column: 1 / -1;
    }
    ul {
      padding-left: 20px;
    }
    .leaflet-control-attribution {
      display: none;
    }
    .search-container {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }
    .search-container input[type="text"] {
      flex: 1;
      padding: 5px;
    }
    .search-container button {
      padding: 5px 10px;
      background-color: #6B8E6F;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #speciesList {
      overflow-y: auto;
      flex: 1;
      height: 100%;
    }
    .filter-header {
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      color: #333;
    }
    .filter-options {
      margin-left: 15px;
      margin-top: 5px;
    }
    .filter-checkbox {
      display: block;
      margin-bottom: 5px;
    }
    .hidden {
      display: none;
    }
    label.family {
      color: black;
      font-weight: bold;
    }
    label.genus {
      color: red;
      font-style: italic;
    }
    label.species {
      color: blue;
      font-style: italic;
    }
    .family-header {
      color: black;
      font-weight: bold;
    }
    .genus-header {
      color: red;
      font-style: italic;
    }
    .species-item {
      color: blue;
      font-style: italic;
      }
  </style>
</head>
<body>
  <div id="header" style="font-size: 28px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
    <img id="logo-right" src="logo_lab.png" alt="Logo NUPELIA">
    Mapa de coletas do Herbário do Núpelia UEM (HNUP-UEM)<br>
    <span style="font-size:20px; font-weight:normal;">Laboratório de Vegetação Ripária - NUPELIA - UEM</span>
    <img id="logo-left" src="logo_uem.jpeg" alt="Logo UEM">
  </div>

  <div id="container">
    <div id="sidebar">
      <div class="box" style="height: 400px; display: flex; flex-direction: column;">
        <div class="box-title">Barra de pesquisa de espécie</div>
        <div class="search-container">
          <input type="text" id="searchBox" placeholder="Digite uma espécie...">
          <button onclick="clearSearch()">Limpar</button>
        </div>
        <div id="speciesList"></div>
        <div style="margin-top: 10px;">
          <button onclick="applyTaxonSelection()" style="margin-right: 10px; padding: 5px 10px;">Aplicar seleção taxonômica</button>
          <button onclick="clearTaxonSelection()" style="padding: 5px 10px;">Limpar seleção</button>
        </div>
      </div>
      <div class="box">
        <div class="box-title">Filtros</div>
        <div>
          <div class="filter-header" onclick="toggleFilter('yearFilter')">Ano de coleta</div>
          <div id="yearFilter" class="filter-options hidden"></div>
          <div class="filter-header" onclick="toggleFilter('municipioFilter')">Localização</div>
          <div id="municipioFilter" class="filter-options hidden"></div>
          <button onclick="clearFilters()" style="margin-top: 10px;">Limpar filtros</button>
        </div>
      </div>
    </div>

    <div class="box" id="map"></div>

    <div class="box" id="info">
      <div class="box-title">Informações relevantes</div>
      <ul>
        <li>A organização da lista de espécies está na ordem: Família (em preto), Gênero (em vermelho) e Espécie (em azul).</li>
        <li>Ao clicar em qualquer um dos níveis, o mapa vai dar um zoom na região das coletas.</li>
        <li>Ao clicar em cima de um localizador de coleta, ele mostra as informações detalhadas da amostra.</li>
        <li>Coletas com coordenadas ausentes são exibidas em (0,0) — estamos corrigindo isso.</li>
        <li>Este site é um projeto do Laboratório de Vegetação Ripária - Núpelia - UEM.</li>
        <li>Link: <a href="https://cpr.uem.br/index.php/catalogos/2415-laboratorio-de-vegetacao-riparia" target="_blank">Site do laboratório</a></li>
        <li>Contato: <a href="mailto:vitorbarelli@gmail.com">vitorbarelli@gmail.com</a></li>
      </ul>
    </div>

    <div class="box" id="links">
      <div class="box-title">Links Importantes</div>
      <ul>
        <li>Site 1 - Link 1</li>
        <li>Site 2 - Link 2</li>
        <li>Site 3 - Link 3</li>
      </ul>
    </div>
  </div>

  <div style="position:fixed; bottom:10px; right:10px; font-size:12px; background:#F2F7F1; padding:5px; border-radius:8px;">
    Criado por Vitor Eduardo Girotto Barelli<br>
    Leaflet | Ⓒ OpenStreetMap contributors
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script>
    // --- Funções auxiliares ---
    function toggleFilter(id) {
      const el = document.getElementById(id);
      el.classList.toggle('hidden');
    }
    
    const map = L.map('map').setView([-22.5, -53.5], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Leaflet | © OpenStreetMap contributors'
    }).addTo(map);
    
    const markers = L.markerClusterGroup();
    const familySpecies = {};
    const genusSpecies = {};
    const speciesMarkers = {};
    const speciesCount = {};
    const genusCount = {};
    const familyCount = {};
    
    fetch('dados1.json')
      .then(res => res.json())
      .then(data => {
        const anos = new Set();
        const municipios = new Set();
    
        data.forEach(d => {
          const sp = d.nome || '';
          if (!sp) return;
          const gen = d.genero || 'Desconhecido';
          const fam = d.familia || 'Desconhecida';
    
          speciesCount[sp] = (speciesCount[sp] || 0) + 1;
          if (!familySpecies[fam]) familySpecies[fam] = new Set();
          familySpecies[fam].add(gen);
          if (!genusSpecies[gen]) genusSpecies[gen] = new Set();
          genusSpecies[gen].add(sp);
    
          if (d.ano_coleta !== undefined) anos.add(d.ano_coleta);
          if (d.municipio) municipios.add(d.municipio);
    
          const popup = `<b>Espécie:</b> ${sp}<br><b>Gênero:</b> ${gen}<br><b>Família:</b> ${fam}<br><br>` +
                        `<b>Ano de coleta:</b> ${d.ano_coleta || 'Não informado'}<br>` +
                        `<b>Município:</b> ${d.municipio || 'Não informado'}<br>` +
                        `<b>Coletas:</b> ${d.numero_coletas || 'Não informado'}<br>` +
                        `<b>Habitat:</b> ${d.habitat || 'Não informado'}<br>` +
                        `<b>Descrição:</b> ${d.descricao || '—'}<br>` +
                        `<b>Notas:</b> ${d.notas || '—'}`;
    
          const m = L.marker([d.latitude, d.longitude]).bindPopup(popup);
          markers.addLayer(m);
          if (!speciesMarkers[sp]) speciesMarkers[sp] = [];
          speciesMarkers[sp].push(m);
        });
    
        map.addLayer(markers);
        Object.keys(genusSpecies).forEach(gen => {
          genusCount[gen] = 0;
          genusSpecies[gen].forEach(sp => {
            genusCount[gen] += speciesCount[sp] || 0;
          });
        });
        Object.keys(familySpecies).forEach(fam => {
          familyCount[fam] = 0;
          familySpecies[fam].forEach(gen => {
            familyCount[fam] += genusCount[gen] || 0;
          });
        });
        populateFilters(anos, municipios);
        populateList();
      });
    
    function populateFilters(anos, municipios) {
      const yearFilter = document.getElementById('yearFilter');
      [...anos].sort((a, b) => a - b).forEach(ano => {
        if (ano === 0 || ano === '0') return;
        const label = document.createElement('label');
        label.className = 'filter-checkbox';
        label.innerHTML = `<input type="checkbox" name="year" value="${ano}" onchange="applyFilters()"> ${ano}`;
        yearFilter.appendChild(label);
      });
    
      const municipioFilter = document.getElementById('municipioFilter');
      [...municipios].sort().forEach(m => {
        const label = document.createElement('label');
        label.className = 'filter-checkbox';
        label.innerHTML = `<input type="checkbox" name="municipio" value="${m}" onchange="applyFilters()"> ${m}`;
        municipioFilter.appendChild(label);
      });
    }
    
    function applyFilters() {
      const years = [...document.querySelectorAll('input[name="year"]:checked')].map(el => el.value);
      const municipios = [...document.querySelectorAll('input[name="municipio"]:checked')].map(el => el.value);
    
      markers.clearLayers();
      const arr = [];
    
      Object.keys(speciesMarkers).forEach(sp => {
        speciesMarkers[sp].forEach(m => {
          const popup = m.getPopup().getContent();
          const matchYear = years.length === 0 || years.some(y => popup.includes(y));
          const matchMunicipio = municipios.length === 0 || municipios.some(m => popup.includes(m));
          if (matchYear && matchMunicipio) {
            markers.addLayer(m);
            arr.push(m);
          }
        });
      });
    
      if (arr.length) map.fitBounds(L.featureGroup(arr).getBounds().pad(0.25));
    }
    
    function populateList() {
      const ul = document.getElementById('speciesList');
      ul.innerHTML = '';
      window.selectedFamilies = new Set();
      window.selectedGenera = new Set();
      window.selectedSpecies = new Set();
    
      const searchBox = document.createElement('input');
      searchBox.type = 'text';
      searchBox.id = 'searchBox';
      searchBox.placeholder = 'Digite uma espécie...';
      searchBox.className = 'search-box';
      searchBox.addEventListener('input', searchSpecies);
      ul.appendChild(searchBox);
    
      const buttonBlock = document.createElement('div');
      buttonBlock.className = 'taxon-buttons';
      buttonBlock.innerHTML = `
        <button onclick="applyTaxonSelection()">Aplicar seleção taxonômica</button>
        <button onclick="clearTaxonSelection()">Limpar seleção</button>
      `;
      ul.appendChild(buttonBlock);
    
      Object.keys(familySpecies).sort().forEach(fam => {
        const fli = document.createElement('div');
        fli.innerHTML = `<label class="family-header"><input type="checkbox" class="taxon-checkbox" data-type="family" value="${fam}"> ${fam} (${familyCount[fam] || 0})</label>`;
        ul.appendChild(fli);
        const famBlock = document.createElement('div');
        famBlock.style.marginLeft = '15px';
        ul.appendChild(famBlock);
    
        Array.from(familySpecies[fam]).sort().forEach(gen => {
          const gli = document.createElement('div');
          gli.innerHTML = `<label class="genus-header"><input type="checkbox" class="taxon-checkbox" data-type="genus" value="${gen}"> ${gen} (${genusCount[gen] || 0})</label>`;
          famBlock.appendChild(gli);
          const genBlock = document.createElement('div');
          genBlock.style.marginLeft = '15px';
          famBlock.appendChild(genBlock);
    
          Array.from(genusSpecies[gen]).sort().forEach(sp => {
            const sli = document.createElement('div');
            sli.innerHTML = `<label class="species-item"><input type="checkbox" class="taxon-checkbox" data-type="species" value="${sp}"> ${sp} (${speciesCount[sp] || 0})</label>`;
            genBlock.appendChild(sli);
          });
        });
      });
    }
    
    function applyTaxonSelection() {
      selectedFamilies.clear();
      selectedGenera.clear();
      selectedSpecies.clear();
    
      document.querySelectorAll('.taxon-checkbox:checked').forEach(el => {
        const type = el.getAttribute('data-type');
        const val = el.value;
        if (type === 'family') selectedFamilies.add(val);
        else if (type === 'genus') selectedGenera.add(val);
        else if (type === 'species') selectedSpecies.add(val);
      });
    
      markers.clearLayers();
      const arr = [];
    
      Object.keys(speciesMarkers).forEach(sp => {
        const matches =
          selectedSpecies.has(sp) ||
          Array.from(selectedGenera).some(gen => genusSpecies[gen]?.has(sp)) ||
          Array.from(selectedFamilies).some(fam => {
            return Array.from(familySpecies[fam] || []).some(gen => genusSpecies[gen]?.has(sp));
          });
    
        if (matches) {
          speciesMarkers[sp].forEach(m => {
            markers.addLayer(m);
            arr.push(m);
          });
        }
      });
    
      if (arr.length) map.fitBounds(L.featureGroup(arr).getBounds().pad(0.25));
    }
    
    function clearTaxonSelection() {
      document.querySelectorAll('.taxon-checkbox').forEach(el => el.checked = false);
      selectedFamilies.clear();
      selectedGenera.clear();
      selectedSpecies.clear();
      clearSearch();
    }
    
    function searchSpecies() {
      const query = document.getElementById('searchBox').value.trim();
      if (query && speciesMarkers[query]) focusSp(query);
    }
    
    function clearSearch() {
      document.getElementById('searchBox').value = '';
      markers.clearLayers();
      Object.values(speciesMarkers).flat().forEach(m => markers.addLayer(m));
      map.setView([-22.5, -53.5], 2);
    }
    
    function clearFilters() {
      document.querySelectorAll('input[name="year"]:checked, input[name="municipio"]:checked')
        .forEach(input => input.checked = false);
      applyFilters();
    }
  </script>
</body>
</html>
