<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa de coletas do Herbário do Núpelia UEM (HNUP-UEM)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #EAF3E1;
    }
    #header {
      background-color: #6B8E6F;
      display: flex;
      flex-direction: column;
      justify-content: center; /* Centraliza verticalmente */
      align-items: center;     /* Centraliza horizontalmente */
      text-align: center;
      font-weight: bold;
      font-size: 24px; /* Aumenta a fonte */
      height: 100px;   /* Aumenta altura se quiser mais espaço */
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 0;
    }
    #logo-left, #logo-right {
      position: absolute;
      top: 0;
      height: 100%;
    }
    #logo-left { left: 0; }
    #logo-right { right: 0; }

    #container {
      display: grid;
      grid-template-columns: 250px 300px 1fr;
      grid-template-rows: auto auto auto;
      gap: 10px;
      padding: 10px;
    }
    #sidebar {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .box {
      background-color: #F2F7F1;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .box-title {
      background-color: #6B8E6F;
      color: white;
      padding: 5px 10px;
      border-radius: 10px 10px 0 0;
      font-weight: bold;
    }
    #map {
      background-color: #6B8E6F;
      border-radius: 10px;
      height: 500px;
    }

    #species {
      height: 500px;
      display: flex;
      flex-direction: column;
    }
    
    #speciesHeader {
      flex-shrink: 0;
    }
    
    #speciesList.scroll-species-list {
      flex: 1;
      overflow-y: auto;
      margin-top: 10px;
    }
        /* Ajusta altura máxima das caixas laterais*/
    #filters {
      height: 500px;
      overflow-y: auto;
    }
    
    /* Estiliza a barra de rolagem (opcional, mas deixa mais bonito) */
    #filters::-webkit-scrollbar,
    #species::-webkit-scrollbar {
      width: 8px;
    }
    
    #filters::-webkit-scrollbar-thumb,
    #species::-webkit-scrollbar-thumb {
      background-color: #A2B8A5;
      border-radius: 5px;
    }
    #info, #links {
      grid-column: 1 / -1;
    }
    ul {
      padding-left: 20px;
    }
    .leaflet-control-attribution {
      display: none;
    }
    .family-header {
      color: black;
      font-weight: bold;
    }
    .genus-header {
      color: red;
      font-style: italic;
    }
    .species-item {
      color: blue;
      font-style: italic;
    }
    .search-box {
      width: 100%;
      margin-bottom: 5px;
      box-sizing: border-box;
      padding: 5px;
    }
    .taxon-buttons button {
      margin-bottom: 5px;
      width: 100%;
    }
    .filter-header {
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      color: #333;
    }
    .filter-options {
      margin-left: 15px;
      margin-top: 5px;
    }
    .filter-checkbox {
      display: block;
      margin-bottom: 5px;
    }
    .hidden {
      display: none;
    }
    #speciesDetails, #speciesChart {
      height: 300px;
    }
    
    #speciesDetails {
      grid-column: 1 / 2;
    }
    
    #speciesChart {
      grid-column: 2 / 4;
      height: 300px;
      display: flex;
      flex-direction: column;
    }
    
    #speciesChartCanvas {
      flex: 1;
      width: 100% !important;
      height: 100% !important;
    }

    #speciesLinkContent {
      padding: 10px;
      font-size: 14px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="header">
    <img id="logo-left" src="logo_uem.jpeg" alt="Logo UEM">
    <div style="font-size: 28px;">Mapa de coletas do Herbário do Núpelia UEM (HNUP-UEM)</div>
    <div style="font-size: 24px; font-weight: normal;">Laboratório de Vegetação Ripária - NUPELIA - UEM</div>
    <img id="logo-right" src="logo_lab.png" alt="Logo NUPELIA">
  </div>

  <div id="container">
      <!-- Coluna 1 - Filtros -->
    <div id="filters" class="box">
      <div class="box-title">Filtros</div>
      <div>
        <div class="filter-header" onclick="toggleFilter('yearFilter')">Ano de coleta</div>
        <div id="yearFilter" class="filter-options hidden"></div>
        <div class="filter-header" onclick="toggleFilter('municipioFilter')">Localização</div>
        <div id="municipioFilter" class="filter-options hidden"></div>
        <button onclick="clearFilters()" style="margin-top: 10px; width: 100%;">Limpar filtros</button>
      </div>
    </div>
  
    <!-- Coluna 2 - Lista de espécies -->
    <div id="species" class="box">
      <div class="box-title">Barra de pesquisa de espécie</div>
        <!-- Contêiner fixo (sem rolagem) -->
      <div id="speciesHeader">
        <input type="text" id="searchBox" placeholder="Digite uma espécie..." class="search-box" list="speciesSuggestions">
        <datalist id="speciesSuggestions"></datalist>
        <div class="taxon-buttons">
          <button onclick="applyTaxonSelection()">Aplicar seleção taxonômica</button>
          <button onclick="clearTaxonSelection()">Limpar seleção</button>
        </div>
      </div>
    
      <!-- Contêiner com rolagem -->
      <div id="speciesList" class="scroll-species-list"></div>
    </div>
 
    <!-- Coluna 3 - Mapa -->
    <div class="box" id="map" style="height: 500px;"></div>

    <!-- Nova linha: Informações e Gráfico -->
    <div id="speciesDetails" class="box">
      <div class="box-title">Mais informações sobre a espécie selecionada</div>
      <div id="speciesLinkContent">Selecione uma espécie para visualizar os dados.</div>
    </div>
    
    <div id="speciesChart" class="box">
      <div class="box-title">Gráfico de coletas</div>
      <canvas id="speciesChartCanvas" style="width: 100%; height: 100%;"></canvas>
    </div>
    
    <!-- Informações relevantes -->
    <div class="box" id="info" style="grid-column: 1 / -1;">
      <div class="box-title">Informações relevantes</div>
      <ul>
        <li>A organização da lista de espécies está na ordem: Família (em preto), Gênero (em vermelho) e Espécie (em azul).</li>
        <li>Para utilizar a caixa de busca "Digite uma espécie..." deve ser escrito o epíteto específico, ou seja, o segundo nome da espécie, e deve estar escrito corretamente como informado na lista.</li>
        <li>Ao marcar uma caixinha de qualquer um dos níveis, clique em "Aplicar seleção taxonômica" para o mapa atualizar, quando terminar sua vizualização clique em "Limpar seleção" para reiniciar o mapa. Vale lembrar que você pode selecionar mais de uma caixinha de cada um dos níveis por vez.</li>
        <li>Ao clicar em cima de um localizador de coleta, ele mostra as informações detalhadas da amostra.</li>
        <li>O mapa não apresenta todas as coletas, pois algumas ainda não tem coordenadas, estamos resolvendo isso!</li>
        <li>Para utilizar os "Filtros" selecione o filtro e marque a caixinha de qualquer um dos níveis, clique em "Aplicar seleção taxonômica" para o mapa/gráfico atualizarem com os "Filtros" escolhidos, quando terminar sua vizualização clique em "Limpar seleção" para reiniciar o mapa e o gráfico. Vale lembrar que você pode utilizar apenas os "Filtros" sem selecionar as caixinhas dos níveis, ai o mapa e gráfico mostrará todas as coletas daquele ano ou daquele município</li>
        <li>Para vizualizar os "Filtros" só clicar neles, clicando novamente tu vai recolher eles.</li>
        <li>Este site é um projeto do Laboratório de Vegetação Ripária - Núpelia - UEM.</li>
        <li>Link: <a href="https://cpr.uem.br/index.php/catalogos/2415-laboratorio-de-vegetacao-riparia" target="_blank">Site do laboratório</a></li>
        <li>Contato: <a href="mailto:vitorbarelli@gmail.com">vitorbarelli@gmail.com</a></li>
      </ul>
    </div>
  
    <!-- Links importantes -->
    <div class="box" id="links" style="grid-column: 1 / -1;">
      <div class="box-title">Links Importantes</div>
      <ul>
        <li>Site 1 - Link 1</li>
        <li>Site 2 - Link 2</li>
        <li>Site 3 - Link 3</li>
      </ul>
    </div>
  </div>

  <div style="position:fixed; bottom:10px; right:10px; font-size:12px; background:#F2F7F1; padding:5px; border-radius:8px;">
    Criado por Vitor Eduardo Girotto Barelli<br>
    Leaflet | Ⓒ OpenStreetMap contributors
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="mapa_script.js"></script>
  <script>
    // --- Funções auxiliares ---
    function updateSpeciesDetailsBoxSiteSearch() {
      const box = document.getElementById('speciesLinkContent');
      if (!box) return;
    
      const terms = termsForSpeciesLinkSearch();
    
      if (!terms.length) {
        box.innerHTML = 'Selecione uma espécie para visualizar os dados.';
        return;
      }
    
      const lis = terms.map(t => {
        const url = 'https://www.google.com/search?q=' +
          encodeURIComponent(`site:reflora.jbrj.gov.br/reflora/listaBrasil "${t}"`);
        return `<li><a href="${url}" target="_blank" rel="noopener">${t}</a></li>`;
      }).join('');
    
      box.innerHTML = `
        <div><strong>Selecionado(s):</strong></div>
        <ul>${lis}</ul>
        <div style="margin-top:6px;font-size:12px;color:#444">
          * Os links abrem no Google uma busca restrita ao Reflora (ListaBrasil),
          já com o termo selecionado (ex.: <code>Dicliptera squarrosa</code>).
        </div>
      `;
    }
    
    function toggleFilter(id) {
      const el = document.getElementById(id);
      el.classList.toggle('hidden');
    }
    
    const map = L.map('map').setView([-22.5, -53.5], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Leaflet | © OpenStreetMap contributors'
    }).addTo(map);
    
    const markers = L.markerClusterGroup();
    const familySpecies = {};
    const genusSpecies = {};
    const speciesMarkers = {};
    const speciesCount = {};
    const genusCount = {};
    const familyCount = {};
    
    fetch('dados1.json')
      .then(res => res.json())
      .then(data => {
        const anos = new Set();
        const municipios = new Set();
    
        data.forEach(d => {
          const sp = d.nome || '';
          if (!sp) return;
          const gen = d.genero || 'Desconhecido';
          const fam = d.familia || 'Desconhecida';

          // 🚫 Ignorar coletas sem coordenadas ou com (0,0)
          if (!d.latitude || !d.longitude || (d.latitude === 0 && d.longitude === 0)) {
            return;
          }
    
          speciesCount[sp] = (speciesCount[sp] || 0) + 1;
          if (!familySpecies[fam]) familySpecies[fam] = new Set();
          familySpecies[fam].add(gen);
          if (!genusSpecies[gen]) genusSpecies[gen] = new Set();
          genusSpecies[gen].add(sp);
    
          if (d.ano_coleta !== undefined) anos.add(d.ano_coleta);
          if (d.municipio) municipios.add(d.municipio);
    
          const popup = `<b>Espécie:</b> ${sp}<br><b>Gênero:</b> ${gen}<br><b>Família:</b> ${fam}<br><br>` +
                        `<b>Ano de coleta:</b> ${d.ano_coleta || 'Não informado'}<br>` +
                        `<b>Município:</b> ${d.municipio || 'Não informado'}<br>` +
                        `<b>Coletas:</b> ${d.numero_coletas || 'Não informado'}<br>` +
                        `<b>Habitat:</b> ${d.habitat || 'Não informado'}<br>` +
                        `<b>Descrição:</b> ${d.descricao || '—'}<br>` +
                        `<b>Notas:</b> ${d.notas || '—'}`;
    
          const m = L.marker([d.latitude, d.longitude]).bindPopup(popup);
          // Salva metadados para filtros e gráfico
          m.__year = d.ano_coleta ? String(d.ano_coleta) : null;
          m.__municipio = d.municipio || null;
          markers.addLayer(m);
          if (!speciesMarkers[sp]) speciesMarkers[sp] = [];
          speciesMarkers[sp].push(m);
        });
    
        map.addLayer(markers);
        Object.keys(genusSpecies).forEach(gen => {
          genusCount[gen] = 0;
          genusSpecies[gen].forEach(sp => {
            genusCount[gen] += speciesCount[sp] || 0;
          });
        });
        Object.keys(familySpecies).forEach(fam => {
          familyCount[fam] = 0;
          familySpecies[fam].forEach(gen => {
            familyCount[fam] += genusCount[gen] || 0;
          });
        });
        populateFilters(anos, municipios);
        populateList();
        updateSpeciesChart({ families: [], genera: [], species: [] });
      });
    
    function populateFilters(anos, municipios) {
      const yearFilter = document.getElementById('yearFilter');
      [...anos].sort((a, b) => a - b).forEach(ano => {
        if (ano === 0 || ano === '0') return;
        const label = document.createElement('label');
        label.className = 'filter-checkbox';
        label.innerHTML = `<input type="checkbox" name="year" value="${ano}" onchange="applyFilters()"> ${ano}`;
        yearFilter.appendChild(label);
      });
    
      const municipioFilter = document.getElementById('municipioFilter');
      [...municipios].sort().forEach(m => {
        const label = document.createElement('label');
        label.className = 'filter-checkbox';
        label.innerHTML = `<input type="checkbox" name="municipio" value="${m}" onchange="applyFilters()"> ${m}`;
        municipioFilter.appendChild(label);
      });
    }
    
    function applyFilters() {
      const years = [...document.querySelectorAll('input[name="year"]:checked')].map(el => el.value);
      const municipios = [...document.querySelectorAll('input[name="municipio"]:checked')].map(el => el.value);
    
      markers.clearLayers();
      const arr = [];
    
      Object.keys(speciesMarkers).forEach(sp => {
        speciesMarkers[sp].forEach(m => {
          const popup = m.getPopup().getContent();
          const matchYear = years.length === 0 || years.some(y => popup.includes(y));
          const matchMunicipio = municipios.length === 0 || municipios.some(m => popup.includes(m));
          if (matchYear && matchMunicipio) {
            markers.addLayer(m);
            arr.push(m);
          }
        });
      });
    
      if (arr.length) map.fitBounds(L.featureGroup(arr).getBounds().pad(0.25));
      const selection = {
        families: [...(window.selectedFamilies || [])],
        genera:   [...(window.selectedGenera   || [])],
        species:  [...(window.selectedSpecies  || [])]
      };
      updateSpeciesChart(selection);
    }
    
    function populateList() {
        const ul = document.getElementById('speciesList');
        ul.innerHTML = '';
        window.selectedFamilies = new Set();
        window.selectedGenera = new Set();
        window.selectedSpecies = new Set();
      
        const searchBox = document.getElementById('searchBox');
        searchBox.addEventListener('input', searchSpecies);
      
        searchBox.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            searchSpecies();
          }
        });
      
        // Preenchimento da lista taxonômica
        Object.keys(familySpecies).sort().forEach(fam => {
          const fli = document.createElement('div');
          fli.innerHTML = `<label class="family-header"><input type="checkbox" class="taxon-checkbox" data-type="family" value="${fam}"> ${fam} (${familyCount[fam] || 0})</label>`;
          ul.appendChild(fli);
          const famBlock = document.createElement('div');
          famBlock.style.marginLeft = '15px';
          ul.appendChild(famBlock);
      
          Array.from(familySpecies[fam]).sort().forEach(gen => {
            const gli = document.createElement('div');
            gli.innerHTML = `<label class="genus-header"><input type="checkbox" class="taxon-checkbox" data-type="genus" value="${gen}"> ${gen} (${genusCount[gen] || 0})</label>`;
            famBlock.appendChild(gli);
            const genBlock = document.createElement('div');
            genBlock.style.marginLeft = '15px';
            famBlock.appendChild(genBlock);
      
            Array.from(genusSpecies[gen]).sort().forEach(sp => {
              const sli = document.createElement('div');
              sli.innerHTML = `<label class="species-item"><input type="checkbox" class="taxon-checkbox species-checkbox" data-type="species" data-name="${sp}" value="${sp}"> ${sp} (${speciesCount[sp] || 0})</label>`;
              genBlock.appendChild(sli);
            });
          });
        });
      
        // Preencher autocomplete
        const datalist = document.getElementById('speciesSuggestions');
        if (datalist) {
          datalist.innerHTML = '';
          Object.keys(speciesMarkers).sort().forEach(sp => {
            const option = document.createElement('option');
            option.value = sp;
            datalist.appendChild(option);
          });
        }
    }
    function applyTaxonSelection() {
        console.log("Aplicando seleção taxonômica:");
        console.log("Espécies selecionadas:", [...window.selectedSpecies]);
        console.log("Anos selecionados:", [...document.querySelectorAll('input[name="year"]:checked')].map(el => el.value));
        console.log("Municípios selecionados:", [...document.querySelectorAll('input[name="municipio"]:checked')].map(el => el.value));
        selectedFamilies.clear();
        selectedGenera.clear();
        selectedSpecies.clear();
      
        document.querySelectorAll('.taxon-checkbox:checked').forEach(el => {
          const type = el.getAttribute('data-type');
          const val = el.value;
          if (type === 'family') selectedFamilies.add(val);
          else if (type === 'genus') selectedGenera.add(val);
          else if (type === 'species') selectedSpecies.add(val);
        });
      
        const years = [...document.querySelectorAll('input[name="year"]:checked')].map(el => el.value);
        const municipios = [...document.querySelectorAll('input[name="municipio"]:checked')].map(el => el.value);
      
        markers.clearLayers();
        const arr = [];
      
        Object.keys(speciesMarkers).forEach(sp => {
          const matchesTaxon =
            selectedSpecies.has(sp) ||
            Array.from(selectedGenera).some(gen => genusSpecies[gen]?.has(sp)) ||
            Array.from(selectedFamilies).some(fam => {
              return Array.from(familySpecies[fam] || []).some(gen => genusSpecies[gen]?.has(sp));
            });
        
          if (!matchesTaxon) return;
        
          speciesMarkers[sp].forEach(m => {
            const popup = m.getPopup().getContent();
        
            // Filtros ambientais
            const matchYear = years.length === 0 || years.some(y => popup.includes(y));
            const matchMunicipio = municipios.length === 0 || municipios.some(mun => popup.includes(mun));
       
            if (matchYear && matchMunicipio) {
              markers.addLayer(m);
              arr.push(m);
            }
          });
        });
      
        if (arr.length) map.fitBounds(L.featureGroup(arr).getBounds().pad(0.25));
        // --- Atualiza o gráfico com as espécies filtradas ---
        const selection = {
          families: [...selectedFamilies],
          genera:   [...selectedGenera],
          species:  [...selectedSpecies]
        };
    updateSpeciesChart(selection);
    updateSpeciesDetailsBoxSiteSearch();
    }
    
    function clearTaxonSelection() {
      document.querySelectorAll('.taxon-checkbox').forEach(el => el.checked = false);
      selectedFamilies.clear();
      selectedGenera.clear();
      selectedSpecies.clear();
      clearSearch();
      updateSpeciesChart({ families: [], genera: [], species: [] });
      updateSpeciesDetailsBoxSiteSearch();
    }
    
    function searchSpecies() {
      const query = document.getElementById('searchBox').value.trim().toLowerCase();
      const match = Object.keys(speciesMarkers).find(sp => sp.toLowerCase().includes(query));
    
      console.log("Query:", query);
      console.log("Match encontrado:", match);
    
      if (!match) return;
    
      // Limpa seleções anteriores
      window.selectedFamilies.clear();
      window.selectedGenera.clear();
      window.selectedSpecies.clear();
    
      // Adiciona a espécie encontrada à seleção
      window.selectedSpecies.add(match);
    
      // Marca a checkbox correspondente, se existir
      const checkboxes = document.querySelectorAll('.species-checkbox');
      checkboxes.forEach(cb => {
        if (cb.dataset.name.toLowerCase() === match.toLowerCase()) {
          cb.checked = true;
        } else {
          cb.checked = false;
        }
      });
    
      // Atualiza o mapa e o gráfico com os novos filtros
      applyTaxonSelection();
    }

    function getActiveFilters() {
      const years = [...document.querySelectorAll('input[name="year"]:checked')].map(el => String(el.value));
      const municipios = [...document.querySelectorAll('input[name="municipio"]:checked')].map(el => el.value);
      return { years, municipios };
    }
    
    function clearSearch() {
      document.getElementById('searchBox').value = '';
      markers.clearLayers();
      Object.values(speciesMarkers).flat().forEach(m => markers.addLayer(m));
      map.setView([-22.5, -53.5], 2);
    }
    
    function clearFilters() {
      document.querySelectorAll('input[name="year"]:checked, input[name="municipio"]:checked')
        .forEach(input => input.checked = false);
      applyFilters();
    }
      
      // transforma epíteto → "Genus epíteto"
      function resolveSpeciesQueries(epithetOrName) {
        if (/\s/.test(epithetOrName)) return [epithetOrName]; // já é "Genus species"
        const results = [];
        for (const gen of Object.keys(genusSpecies)) {
          if (genusSpecies[gen] && genusSpecies[gen].has(epithetOrName)) {
            results.push(`${gen} ${epithetOrName}`);
          }
        }
        return results.length ? results : [epithetOrName];
      }
    
      // Preferência: espécies > gêneros > famílias
      let items = [];
      let label = '';
      let makeUrl = (name) => '#';
    
      if (selection.species?.length) {
        items = selection.species.flatMap(resolveSpeciesQueries); // vira binomiais
        label = 'Espécie';
        makeUrl = (binomial) => linkFloraFungaTaxon(binomial);    // página do táxon
      } else if (selection.genera?.length) {
        items = selection.genera;
        label = 'Gênero';
        makeUrl = (gen) => linkFloraFungaSearch(gen);             // busca por gênero
      } else if (selection.families?.length) {
        items = selection.families;
        label = 'Família';
        makeUrl = (fam) => linkFloraFungaSearch(fam);             // busca por família
      }
    
      const links = items.map(name => {
        const url = makeUrl(name);
        return `<li><a href="${url}" target="_blank" rel="noopener">${name}</a></li>`;
      }).join('');
    
      box.innerHTML = `
        <div style="margin-bottom:8px;"><b>${label}(s) selecionado(s):</b></div>
        <ul style="margin:0 0 8px 16px;">${links}</ul>
        <div style="font-size:12px;opacity:.8">
          * Os links abrem diretamente no portal <i>Flora e Funga do Brasil</i>.
        </div>
      `;
    }
    
    function focusSp(sp) {
      const markersArray = speciesMarkers[sp];
      if (!markersArray || markersArray.length === 0) return;
    
      // Dá zoom no primeiro marcador da espécie
      const group = L.featureGroup(markersArray);
      map.fitBounds(group.getBounds().pad(0.25));
    
      // Abre popup do primeiro marcador
      markersArray[0].openPopup();
    }

    function termsForSpeciesLinkSearch() {
      const terms = [];
    
      // espécies → "Gênero epíteto"
      for (const sp of (window.selectedSpecies || [])) {
        const gen = Object.keys(genusSpecies).find(g => genusSpecies[g]?.has(sp));
        if (gen) terms.push(`${gen} ${sp}`);
      }
    
      // gêneros → "Gênero"
      for (const gen of (window.selectedGenera || [])) terms.push(gen);
    
      // famílias → "Família"
      for (const fam of (window.selectedFamilies || [])) terms.push(fam);
    
      return terms;
    }
    
    function updateSpeciesDetailsBoxReflora() {
      const box = document.getElementById('speciesLinkContent');
      if (!box) return;
    
      // Monta termos considerando prioridade: espécies > gêneros > famílias
      const selectedSpecies = [...(window.selectedSpecies || [])];
      const selectedGenera  = [...(window.selectedGenera  || [])];
      const selectedFamilies= [...(window.selectedFamilies|| [])];
    
      // se a espécie vier só com o epíteto, vira "Gênero epíteto"
      const speciesTerms = selectedSpecies.flatMap(epithet => {
        const gens = Object.keys(genusSpecies).filter(g => genusSpecies[g]?.has(epithet));
        return gens.length ? gens.map(g => `${g} ${epithet}`) : [epithet];
      });
    
      const items =
        speciesTerms.length ? speciesTerms :
        selectedGenera.length ? selectedGenera :
        selectedFamilies;
    
      if (!items.length) {
        box.innerHTML = 'Selecione uma espécie para visualizar os dados.';
        return;
      }
    
      const links = items.map(name => {
        let url;
        if (/\s/.test(name)) {
          // é "Genus epithet": divide para passar {genero, especie}
          const [gen, ...rest] = name.split(/\s+/);
          const epithet = rest.join(' ');
          url = gerarLinkReflora(gen, epithet);
        } else {
          // gênero ou família: usa o mesmo parâmetro de "Nome Completo"
          const q = encodeURIComponent(name);
          url = `https://reflora.jbrj.gov.br/reflora/listaBrasil/ConsultaPublicaUC/ResultadoDaConsulta.do?condicao.taxonomia.nomeCompleto=${q}`;
        }
        return `<li><a href="${url}" target="_blank" rel="noopener">${name}</a></li>`;
      }).join('');
    
      box.innerHTML = `
        <div style="margin-bottom:8px;"><b>Selecionado(s):</b></div>
        <ul style="margin:0 0 8px 16px;">${links}</ul>
        <div style="font-size:12px;opacity:.8">
          * Os links abrem a busca diretamente no <b>Reflora – Lista Brasil</b>.
        </div>
      `;
    }
    
    function updateSpeciesChart(selection) {
      const canvas = document.getElementById('speciesChartCanvas');
      if (!canvas) return;
      const { years: activeYears, municipios: activeMunicipios } = getActiveFilters();
    
      // helper: retorna todas as espécies que pertencem a um item selecionado
      function speciesForItem(type, name) {
        if (type === 'species') return [name];
        if (type === 'genus')   return Array.from(genusSpecies[name] || []);
        if (type === 'family') {
          const gens = Array.from(familySpecies[name] || []);
          return gens.flatMap(g => Array.from(genusSpecies[g] || []));
        }
        return [];
      }
    
      // Se nada selecionado: dataset único com total por ano
      const nothingSelected = !selection || (
        selection.families?.length === 0 &&
        selection.genera?.length   === 0 &&
        selection.species?.length  === 0
      );
    
      // Colete todos os anos existentes (chave comum) para alinhar datasets
      const allYearsSet = new Set();
    
      // Função que conta por ano para uma lista de espécies
      function countByYearForSpeciesList(spList) {
        const counts = {};
        spList.forEach(sp => {
          (speciesMarkers[sp] || []).forEach(marker => {
            const y = marker.__year ? String(marker.__year) : null;
            const muni = marker.__municipio || null;
      
            const matchYear = activeYears.length === 0 || (y && activeYears.includes(y));
            const matchMunicipio = activeMunicipios.length === 0 || (muni && activeMunicipios.includes(muni));
      
            if (matchYear && matchMunicipio && y) {
              counts[y] = (counts[y] || 0) + 1;
              allYearsSet.add(y);
            }
          });
        });
        return counts;
      }
    
      let datasets = [];
      let chartTitle = 'Coletas por ano';
    
      if (nothingSelected) {
        // total por ano (todas as espécies)
        const totalCounts = countByYearForSpeciesList(Object.keys(speciesMarkers));
        const years = Array.from(new Set(Object.keys(totalCounts))).sort();
        const values = years.map(y => totalCounts[y]);
    
        datasets = [{
          label: 'Total',
          data: values,
          backgroundColor: 'rgba(107,142,111,0.6)',
          borderColor: 'rgba(107,142,111,1)',
          borderWidth: 1
        }];
    
        // renderiza (sem empilhamento)
        renderChart({ years, datasets, stacked: false, title: 'Total de coletas por ano' });
        return;
      }
    
      // Há seleção → criar um dataset por caixinha marcada
      const items = [
        ...(selection.families || []).map(n => ({type:'family', name:n})),
        ...(selection.genera   || []).map(n => ({type:'genus',   name:n})),
        ...(selection.species  || []).map(n => ({type:'species', name:n}))
      ];
    
      // Paleta simples (repete se passar do tamanho)
      const baseColors = [
        'rgba(107,142,111,0.75)',  // verde
        'rgba(160,190,165,0.75)',
        'rgba(106,159,181,0.75)',
        'rgba(181,137,110,0.75)',
        'rgba(186,104,123,0.75)',
        'rgba(149,117,205,0.75)',
        'rgba(255,183,77,0.75)',
        'rgba(120,144,156,0.75)'
      ];
      const baseBorders = baseColors.map(c => c.replace('0.75', '1'));
    
      // Primeiro compute os counts de cada item e agregue todos os anos
      const perItemCounts = items.map(it => {
        const spList = speciesForItem(it.type, it.name);
        return { it, counts: countByYearForSpeciesList(spList) };
      });
    
      const years = Array.from(allYearsSet).sort();
    
      // Monte os datasets alinhados por 'years'
      datasets = perItemCounts.map((rec, idx) => ({
        label:
          rec.it.type === 'family' ? `Família: ${rec.it.name}` :
          rec.it.type === 'genus'   ? `Gênero: ${rec.it.name}`   :
                                      `Espécie: ${rec.it.name}`,
        data: years.map(y => rec.counts[y] || 0),
        backgroundColor: baseColors[idx % baseColors.length],
        borderColor:     baseBorders[idx % baseBorders.length],
        borderWidth: 1
      }));
    
      // Título com o resumo da seleção
      const parts = [];
      if (selection.families?.length) parts.push(`Família(s): ${selection.families.join(', ')}`);
      if (selection.genera?.length)   parts.push(`Gênero(s): ${selection.genera.join(', ')}`);
      if (selection.species?.length)  parts.push(`Espécie(s): ${selection.species.join(', ')}`);
      chartTitle = `Coletas por ano — ${parts.join(' | ')}`;
    
      renderChart({ years, datasets, stacked: true, title: chartTitle });
    
      // ------- função que realmente desenha o Chart.js -------
      function renderChart({ years, datasets, stacked, title }) {
        if (window.speciesChartInstance) window.speciesChartInstance.destroy();
    
        // garantir tamanho cheio da caixa
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
    
        const ctx = canvas.getContext('2d');
        window.speciesChartInstance = new Chart(ctx, {
          type: 'bar',
          data: { labels: years, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { bottom: 20 } },
            scales: {
              x: { stacked: !!stacked },
              y: { stacked: !!stacked, beginAtZero: true }
            },
            plugins: {
              legend: { display: stacked }, // mostra legenda quando empilhado
              title: { display: true, text: title }
            }
          }
        });
    
        document.getElementById('speciesChart').style.display = 'block';
      }
    }
  </script>
</body>
</html>
